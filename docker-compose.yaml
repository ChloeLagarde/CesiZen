version: '3.8'

services:
  cesizen-web:
    container_name: cesizen-web
    image: ${CESIZEN_WEB_IMAGE:-cesizen:latest}
    restart: always
    ports:
      - "${WEB_PORT:-80}:80"
    environment:
      - DB_HOST=cesizen-db
      - DB_NAME=${DB_NAME:-cesizentest}
      - DB_USER=${DB_USER:-cesizen}
      - DB_PASS=${DB_PASS:-cesizen123}
      - DB_PORT=3306
    depends_on:
      cesizen-db:
        condition: service_healthy
    volumes:
      - ./uploads:/var/www/html/uploads
    networks:
      - cesizen-network

  cesizen-db:
    container_name: cesizen-db
    image: mariadb:latest
    restart: always
    environment:
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MARIADB_DATABASE: ${DB_NAME:-cesizentest}
      MARIADB_USER: ${DB_USER:-cesizen}
      MARIADB_PASSWORD: ${DB_PASS:-cesizen123}
    volumes:
      - cesizen-db-data:/var/lib/mysql
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${DB_PORT:-3306}:3306"
    healthcheck:
      test: ['CMD', '/usr/local/bin/healthcheck.sh', '--connect', '--innodb_initialized']
      start_period: 10s
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - cesizen-network

  cesizen-adminer:
    container_name: cesizen-adminer
    image: adminer:latest
    restart: always
    ports:
      - "${ADMINER_PORT:-8080}:8080"
    depends_on:
      - cesizen-db
    networks:
      - cesizen-network

volumes:
  cesizen-db-data:
    driver: local

networks:
  cesizen-network:
    driver: bridge