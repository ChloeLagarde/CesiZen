name: 01-2 - Integration SonarQube

on:
  workflow_call

jobs:
  QualityPHP:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_mysql, mysqli, mbstring, zip, exif, pcntl, bcmath, gd
          coverage: xdebug

      - name: Download Coverage Artifact
        uses: actions/download-artifact@v4
        with:
          name: php-coverage-report
          path: ./coverage
        continue-on-error: true  # Au cas où les tests n'ont pas généré de couverture

      - name: Install Composer Dependencies
        run: composer install --no-progress --prefer-dist

      - name: Build and analyze
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
        run: |
          # Vérifier que les tokens existent
          if [ -z "$SONAR_TOKEN" ]; then
            echo "❌ SONAR_TOKEN is not set!"
            echo "ℹ️ Please configure SonarCloud following these steps:"
            echo "1. Go to https://sonarcloud.io"
            echo "2. Login with GitHub"
            echo "3. Create a new project for your repository"
            echo "4. Go to My Account > Security > Generate Token"
            echo "5. Add the token as SONAR_TOKEN in GitHub secrets"
            echo "6. Add your organization key as SONAR_ORGANIZATION"
            echo "7. Add your project key as SONAR_PROJECT_KEY"
            exit 1
          fi
          
          # Configuration avec les valeurs exactes de votre SonarCloud
          ORGANIZATION="${SONAR_ORGANIZATION:-ChloeLagarde}"
          PROJECT_KEY="${SONAR_PROJECT_KEY:-ChloeLagarde_CesiZen}"
          
          echo "🔍 SonarCloud Configuration:"
          echo "- Organization: $ORGANIZATION"
          echo "- Project Key: $PROJECT_KEY"
          echo "- Host: https://sonarcloud.io"
          
          # Installation de SonarScanner pour PHP
          curl -sSLo sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
          unzip -q sonar-scanner.zip
          export PATH=$PWD/sonar-scanner-4.8.0.2856-linux/bin:$PATH
          
          # Création du fichier sonar-project.properties
          cat > sonar-project.properties << EOF
          sonar.projectKey=$PROJECT_KEY
          sonar.projectName=CesiZen
          sonar.projectVersion=1.0
          sonar.organization=$ORGANIZATION
          sonar.sources=controleur,config,vues,api
          sonar.exclusions=vendor/**,tests/**,assets/**,.github/**,docker-compose.yml,Dockerfile,**/*.js,**/*.css,**/*.md
          sonar.php.coverage.reportPaths=coverage.xml,coverage/coverage.xml
          sonar.language=php
          sonar.sourceEncoding=UTF-8
          sonar.scm.provider=git
          sonar.host.url=https://sonarcloud.io
          EOF
          
          echo "📝 Contenu de sonar-project.properties:"
          cat sonar-project.properties
          
          # Lancement de l'analyse SonarCloud
          sonar-scanner \
            -Dsonar.token="$SONAR_TOKEN" \
            -Dsonar.projectKey="$PROJECT_KEY" \
            -Dsonar.organization="$ORGANIZATION" \
            -Dsonar.projectName="CesiZen" \
            -Dsonar.projectVersion="1.0" \
            -Dsonar.sources="controleur,config,vues,api" \
            -Dsonar.exclusions="vendor/**,tests/**,assets/**,.github/**,docker-compose.yml,Dockerfile,**/*.js,**/*.css,**/*.md" \
            -Dsonar.php.coverage.reportPaths="coverage.xml,coverage/coverage.xml" \
            -Dsonar.sourceEncoding="UTF-8" \
            -Dsonar.host.url="https://sonarcloud.io" \
            -Dsonar.verbose=true

      - name: Upload SonarCloud Results
        if: always()
        run: |
          echo "📊 Analyse SonarCloud terminée"
          echo "🔗 Consultez les résultats sur : https://sonarcloud.io/project/overview?id=${SONAR_PROJECT_KEY:-ChloeLagarde_CesiZen}"